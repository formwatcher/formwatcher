<!DOCTYPE html>  <html> <head>   <title>formwatcher.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="date-picker.html">                 date-picker.coffee               </a>                                           <a class="source" href="formwatcher.html">                 formwatcher.coffee               </a>                                           <a class="source" href="hint.html">                 hint.coffee               </a>                                           <a class="source" href="validators.html">                 validators.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               formwatcher.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Formwatcher Version 0.0.7-dev</p>

<p>More infos at http://www.formwatcher.org</p>

<p>Copyright (c) 2012, Matias Meno</p>

<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>

<p>The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.</p>

<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Using ender</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$ = </span><span class="nx">ender</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Returns and stores attributes only for formwatcher.
Be careful when you get data because it does return the actual object, not
a copy of it. So if you manipulate an array, you don't have to store it again.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ender</span>
  <span class="nv">fwData: </span><span class="nf">(name, value) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Create an empty formwatcher object if there isn't one yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@data</span> <span class="s">&quot;_formwatcher&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="p">}</span> <span class="nx">unless</span> <span class="nx">@data</span><span class="p">(</span><span class="s">&quot;_formwatcher&quot;</span><span class="p">)</span><span class="o">?</span>
    
    <span class="k">return</span> <span class="nx">@</span> <span class="nx">unless</span> <span class="nx">name</span><span class="o">?</span>
    <span class="nv">formwatcherAttributes = </span><span class="nx">@data</span><span class="p">(</span><span class="s">&quot;_formwatcher&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">value</span><span class="o">?</span>
      <span class="nx">formwatcherAttributes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
      <span class="nx">@data</span> <span class="s">&quot;_formwatcher&quot;</span><span class="p">,</span> <span class="nx">formwatcherAttributes</span>
      <span class="k">return</span> <span class="nx">@</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">formwatcherAttributes</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
  <span class="p">,</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The selector for all input types</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">inputSelector = </span><span class="s">&quot;input, textarea, select, button&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>Formwatcher, the global namespace</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Formwatcher =</span>
  <span class="nv">version: </span><span class="s">&quot;2.1.9-dev&quot;</span>
  <span class="nv">debugging: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>A wrapper for console.debug that only forwards if <code>Formwatcher.debugging == true</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">debug: </span><span class="o">-&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">arguments</span> <span class="k">if</span> <span class="nx">@debugging</span> <span class="o">and</span> <span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">debug</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Tries to find an existing errors element, and creates one if there isn't.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getErrorsElement: </span><span class="nf">(elements, createIfNotFound) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>First try to see if there is a NAME-errors element, then if there is an ID-errors.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">errors = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">-errors&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
    <span class="nv">errors = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">-errors&quot;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">errors</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">or</span> <span class="o">!</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">errors</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">errors = </span><span class="nx">$</span><span class="p">.</span><span class="nx">create</span> <span class="s">&quot;&lt;small /&gt;&quot;</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;-errors&quot;</span> <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">insertAfter</span> <span class="nx">input</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>input.after errors</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">errors</span>
      <span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&quot;errors&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&quot;fw-errors&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Helper function to deep extend objects</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deepExtend: </span><span class="nf">(object, extenders...) -&gt;</span>
    <span class="k">return</span> <span class="p">{</span> <span class="p">}</span> <span class="nx">unless</span> <span class="nx">object</span><span class="o">?</span>
    <span class="k">for</span> <span class="nx">other</span> <span class="k">in</span> <span class="nx">extenders</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">other</span>
        <span class="nx">unless</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">val</span> <span class="o">is</span> <span class="s">&quot;object&quot;</span>
          <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
        <span class="k">else</span>
          <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@deepExtend</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">val</span>
    <span class="nx">object</span>


  <span class="nv">getLabel: </span><span class="nf">(elements, automatchLabel) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>

    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span>
      <span class="nv">label = </span><span class="nx">$</span> <span class="s">&quot;label[for=&quot;</span> <span class="o">+</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span>
      <span class="nv">label = </span><span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>  <span class="nx">unless</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">label</span> <span class="o">and</span> <span class="nx">automatchLabel</span>
      <span class="nv">parent = </span><span class="nx">input</span><span class="p">.</span><span class="nx">parent</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&quot;LABEL&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The input is embedded inside a label, so take the first span element.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">label = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;span&quot;</span><span class="p">,</span> <span class="nx">parent</span><span class="p">).</span><span class="nx">first</span><span class="p">()</span>
        <span class="nv">label = </span><span class="kc">undefined</span> <span class="k">if</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
      <span class="k">else</span>
        <span class="nv">label = </span><span class="nx">input</span><span class="p">.</span><span class="nx">previous</span><span class="p">()</span>
        <span class="nv">label = </span><span class="kc">undefined</span> <span class="k">if</span> <span class="o">!</span><span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">or</span> <span class="nx">label</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">nodeName</span> <span class="o">isnt</span> <span class="s">&quot;LABEL&quot;</span> <span class="o">or</span> <span class="nx">label</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;for&quot;</span><span class="p">)</span><span class="o">?</span>

    <span class="nx">label</span>

  <span class="nv">changed: </span><span class="nf">(elements, watcher) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">return</span>  <span class="k">if</span> <span class="o">not</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;forceValidationOnChange&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span> <span class="o">and</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;previouslyChecked&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="o">!!</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">checked</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;previousValue&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">())</span>
    <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;forceValidationOnChange&quot;</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nx">@setPreviousValueToCurrentValue</span> <span class="nx">elements</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialyChecked&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">!!</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">checked</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="s">&quot;checkbox&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialValue&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">())</span>
      <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">setChanged</span> <span class="nx">elements</span><span class="p">,</span> <span class="nx">watcher</span>
    <span class="k">else</span>
      <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">unsetChanged</span> <span class="nx">elements</span><span class="p">,</span> <span class="nx">watcher</span>
    <span class="nx">watcher</span><span class="p">.</span><span class="nx">validateElements</span> <span class="nx">elements</span>  <span class="k">if</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">validate</span>

  <span class="nv">setChanged: </span><span class="nf">(elements, watcher) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;changed&quot;</span><span class="p">)</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;changed&quot;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

    <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;changed&quot;</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">restoreName</span> <span class="nx">elements</span>  <span class="nx">unless</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">submitUnchanged</span>
    <span class="nx">watcher</span><span class="p">.</span><span class="nx">submitForm</span><span class="p">()</span>  <span class="k">if</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">submitOnChange</span> <span class="o">and</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ajax</span>

  <span class="nv">unsetChanged: </span><span class="nf">(elements, watcher) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">return</span>  <span class="nx">unless</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;changed&quot;</span><span class="p">)</span>

    <span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;changed&quot;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

    <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;changed&quot;</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">removeName</span> <span class="nx">elements</span> <span class="nx">unless</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">submitUnchanged</span>

  <span class="nv">storeInitialValue: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;initialyChecked&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">checked</span>
    <span class="k">else</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;initialValue&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>

    <span class="nx">@setPreviousValueToInitialValue</span> <span class="nx">elements</span>

  <span class="nv">restoreInitialValue: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;checked&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialyChecked&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">val</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialValue&quot;</span><span class="p">)</span>
    <span class="nx">@setPreviousValueToInitialValue</span> <span class="nx">elements</span>

  <span class="nv">setPreviousValueToInitialValue: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;previouslyChecked&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialyChecked&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;previousValue&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialValue&quot;</span><span class="p">)</span>

  <span class="nv">setPreviousValueToCurrentValue: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;previouslyChecked&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">checked</span>
    <span class="k">else</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;previousValue&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>

  <span class="nv">removeName: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">return</span>  <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
    <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&quot;&quot;</span>  <span class="nx">unless</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
    <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span>

  <span class="nv">restoreName: </span><span class="nf">(elements) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="k">return</span>  <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;checkbox&quot;</span>
    <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>

  <span class="nv">decorators: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><code>decorate()</code> only uses the first decorator found. You can't use multiple decorators on the same input.
If you want to have two decorators applied, you have to create a new decorator joining them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">decorate: </span><span class="nf">(watcher, input) -&gt;</span>
    <span class="nv">decorator = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Like <code>_.detect()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">dec</span> <span class="k">in</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">decorators</span>
      <span class="k">if</span> <span class="nx">dec</span><span class="p">.</span><span class="nx">accepts</span> <span class="nx">input</span>
        <span class="nv">decorator = </span><span class="nx">dec</span>
        <span class="k">break</span>

    <span class="k">if</span> <span class="nx">decorator</span>
      <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Decorator \&quot;&quot;</span> <span class="o">+</span> <span class="nx">decorator</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;\&quot; found for input field \&quot;&quot;</span> <span class="o">+</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;\&quot;.&quot;</span>
      <span class="nx">decorator</span><span class="p">.</span><span class="nx">decorate</span> <span class="nx">input</span>
    <span class="k">else</span>
      <span class="nv">input: </span><span class="nx">input</span>

  <span class="nv">validators: </span><span class="p">[]</span>
  <span class="nv">currentWatcherId: </span><span class="mi">0</span>
  <span class="nv">watchers: </span><span class="p">[]</span>
  <span class="nv">add: </span><span class="nf">(watcher) -&gt;</span>
    <span class="nx">@watchers</span><span class="p">[</span><span class="nx">watcher</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">watcher</span>

  <span class="nv">get: </span><span class="nf">(id) -&gt;</span>
    <span class="nx">@watchers</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>

  <span class="nv">getAll: </span><span class="o">-&gt;</span>
    <span class="nx">@watchers</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Searches all forms with a data-fw attribute and watches them</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scanDocument: </span><span class="o">-&gt;</span>
    <span class="nv">handleForm = </span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">form = </span><span class="nx">$</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>A form can only be watched once!</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">if</span> <span class="nx">form</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;watcher&quot;</span><span class="p">)</span>

      <span class="nv">formId = </span><span class="nx">form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Check if options have been set for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">options = </span><span class="k">if</span> <span class="nx">formId</span><span class="o">?</span> <span class="o">and</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">formId</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">formId</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span> <span class="p">}</span>

      <span class="nv">domOptions = </span><span class="nx">form</span><span class="p">.</span><span class="nx">data</span> <span class="s">&quot;fw&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>domOptions always overwrite the normal options.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">options = </span><span class="nx">@deepExtend</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">domOptions</span> <span class="k">if</span> <span class="nx">domOptions</span>

      <span class="k">new</span> <span class="nx">Watcher</span><span class="p">(</span><span class="nx">form</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;form[data-fw]&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(form) -&gt;</span> <span class="nx">handleForm</span> <span class="nx">form</span>

    <span class="nx">handleForm</span> <span class="nx">$</span> <span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">formId</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">for</span> <span class="nx">formId</span> <span class="k">of</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">options</span>

  <span class="nv">watch: </span><span class="nf">(form, options) -&gt;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">domReady</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Watcher</span> <span class="nx">form</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>The ElementWatcher root class</h2>

<p>This is the base class for decorators and validators.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">_ElementWatcher</span>
  <span class="nv">name: </span><span class="s">&quot;No name&quot;</span>
  <span class="nv">description: </span><span class="s">&quot;No description&quot;</span>
  <span class="nv">nodeNames: </span><span class="kc">null</span> <span class="c1"># eg: `[ &quot;SELECT&quot; ]`</span>
  <span class="nv">classNames: </span><span class="p">[]</span> <span class="c1"># eg: `[ &quot;font&quot; ]`</span>
  <span class="nv">defaultOptions: </span><span class="p">{</span> <span class="p">}</span> <span class="c1">#  Overwrite this with your default options. Those options can be overridden in the watcher config.</span>
  <span class="nv">options: </span><span class="kc">null</span> <span class="c1"># On initialization this gets filled with the actual options so they don&#39;t have to be calculated every time.</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Stores the watcher, and creates a valid options object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@watcher) -&gt;</span>
    <span class="vi">@options = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">deepExtend</span> <span class="p">{</span> <span class="p">},</span> <span class="nx">@defaultOptions</span><span class="p">,</span> <span class="nx">watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">?</span> <span class="p">{</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Overwrite this function if your logic to which elements your decorator applies
is more complicated than a simple nodeName/className comparison.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">accepts: </span><span class="nf">(input) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If the config for a ElementWatcher is just false, it's disabled for the watcher.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">@watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@watcher</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">@name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">false</span>

    <span class="nv">correctNodeName = </span><span class="kc">false</span>
    <span class="nv">inputNodeName = </span><span class="nx">input</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">nodeName</span>

    <span class="k">for</span> <span class="nx">nodeName</span> <span class="k">in</span> <span class="nx">@nodeNames</span>
      <span class="k">if</span> <span class="nx">inputNodeName</span> <span class="o">is</span> <span class="nx">nodeName</span>
        <span class="nv">correctNodeName = </span><span class="kc">true</span>
        <span class="k">break</span>

    <span class="k">return</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">correctNodeName</span>

    <span class="nv">correctClassNames = </span><span class="kc">true</span>

    <span class="k">for</span> <span class="nx">className</span> <span class="k">in</span> <span class="nx">@classNames</span>
      <span class="nx">unless</span> <span class="nx">input</span><span class="p">.</span><span class="nx">hasClass</span> <span class="nx">className</span>
        <span class="nv">correctClassNames = </span><span class="kc">false</span>
        <span class="k">break</span>

    <span class="k">return</span> <span class="nx">correctClassNames</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>Decorator class</h2>

<p>Decorators are used to improve the visuals and user interaction of form elements.</p>

<p>Implement it to create a new decorator.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">Decorator</span> <span class="k">extends</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">_ElementWatcher</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This function does all the magic.
It creates additional elements if necessary, and could instantiate an object
that will be in charge of handling this input.</p>

<p>This function has to return a hash of all fields that you want to get updated
with .focus and .changed classes. Typically this is just { input: THE_INPUT }</p>

<p><code>input</code> has to be the actual form element to transmit the data.
<code>label</code> is reserved for the actual label.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">decorate: </span><span class="nf">(watcher, input) -&gt;</span> <span class="nv">input: </span><span class="nx">input</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h2>Validator class</h2>

<p>Instances of this class are meant to validate input fields</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">Validator</span> <span class="k">extends</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">_ElementWatcher</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Typically most validators work on every input field</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nodeNames: </span><span class="p">[</span> <span class="s">&quot;INPUT&quot;</span><span class="p">,</span> <span class="s">&quot;TEXTAREA&quot;</span><span class="p">,</span> <span class="s">&quot;SELECT&quot;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Return true if the validation passed, or an error message if not.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validate: </span><span class="nf">(sanitizedValue, input) -&gt;</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If your value can be sanitized (eg: integers should not have leading or trailing spaces)
this function should return the sanitized value.</p>

<p>When the user leaves the input field, the value will be updated with this value in the field.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sanitize: </span><span class="nf">(value) -&gt;</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>Default options</h2>

<p>Those are the default options a new watcher uses if nothing is provided.
Overwrite any of these when instantiating a watcher (or put it in <code>data-fw=''</code>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Formwatcher.defaultOptions =</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Whether to convert the form to an AJAX form.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ajax: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>You can set this to force a specific method (eg.: <code>post</code>). If null, the method of the
form attribute <code>method</code> is taken.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ajaxMethod: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Whether or not the form should validate on submission. This will invoke
every validator attached to your input fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validate: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>If ajax and submitOnChange are true, then the form will be submitted every
time an input field is changed. This removes the need of a submit button.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">submitOnChange: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>If the form is submitted via AJAX, the formwatcher uses changed values.
Otherwise formwatcher removes the name parameter of the input fields so they
are not submitted.
Remember: checkboxes are ALWAYS submitted if checked, and never if unchecked.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">submitUnchanged: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>If you have <code>submitUnchanged = false</code> and the user did not change anything and
hit submit, there would not actually be anything submitted to the server.
To avoid that, formwatcher does not actually send the request. But if you want
that behaviour you can set this to true.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">submitFormIfAllUnchanged: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>When the form is submitted with AJAX, this tells the formwatcher how to
leave the form afterwards. Eg: For guestbook posts this should probably be yes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resetFormAfterSubmit: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Creating ids for input fields, and setting the <code>for</code> attribute on the labels
is the right way to go, but can be a tedious task. If automatchLabel is true,
Formwatcher will automatically match the closest previous label without a <code>for</code>
attribute as the correct label.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">automatchLabel: </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Checks the ajax transport if everything was ok. If this function returns
false formwatcher assumes that the form submission resulted in an error.
So, if this function returns true <code>onSuccess</code> will be called. If false,
<code>onError</code> is called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">responseCheck: </span><span class="nf">(data) -&gt;</span> <span class="o">not</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>This function gets called before submitting the form. You could hide the form
or show a spinner here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onSubmit: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>If the responseCheck function returns true, this function gets called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onSuccess: </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>If the responseCheck function returns false, this function gets called.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onError: </span><span class="nf">(data) -&gt;</span> <span class="nx">alert</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>In any case onComplete() is called when the request has been done.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onComplete: </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>This is a map of options for your different forms. You can simply overwrite it
to specify your form configurations, if it is too complex to be put in the
form data-fw='' field.</p>

<p><strong>CAREFUL</strong>: When you set options here, they will be overwritten by the DOM options.</p>

<p>Example:</p>

<pre><code>Formwatcher.options.myFormId = { ajax: true };
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Formwatcher.options = </span><span class="p">{</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2>The Watcher class</h2>

<p>This is the class that gets instantiated for each form.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Watcher</span>
  <span class="nv">constructor: </span><span class="nf">(form, options) -&gt;</span>
    <span class="vi">@form = </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">form</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span> <span class="k">then</span> <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">form</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nx">$</span> <span class="nx">form</span>

    <span class="k">if</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="k">throw</span> <span class="s">&quot;Form element not found.&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">throw</span> <span class="s">&quot;More than one form was found.&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">nodeName</span> <span class="o">isnt</span> <span class="s">&quot;FORM&quot;</span>
      <span class="k">throw</span> <span class="s">&quot;The element was not a form.&quot;</span>

    <span class="vi">@allElements = </span><span class="p">[</span> <span class="p">]</span>
    <span class="vi">@id = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">currentWatcherId</span><span class="o">++</span>
    <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@</span>
    <span class="vi">@observers = </span><span class="p">{</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Putting the watcher object in the form element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@form</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;watcher&quot;</span><span class="p">,</span> <span class="nx">@</span>
    <span class="nx">@form</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;originalAction&quot;</span><span class="p">,</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;action&quot;</span><span class="p">,</span> <span class="s">&quot;javascript:undefined;&quot;</span>
    <span class="vi">@options = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">deepExtend</span> <span class="p">{</span> <span class="p">},</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">defaultOptions</span><span class="p">,</span> <span class="nx">options</span> <span class="o">or</span> <span class="p">{</span> <span class="p">}</span>
    <span class="vi">@decorators = </span><span class="p">[</span> <span class="p">]</span>
    <span class="vi">@validators = </span><span class="p">[</span> <span class="p">]</span>

    <span class="nx">@decorators</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Decorator</span> <span class="nx">@</span> <span class="k">for</span> <span class="nx">Decorator</span> <span class="k">in</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">decorators</span>
    <span class="nx">@validators</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Validator</span> <span class="nx">@</span> <span class="k">for</span> <span class="nx">Validator</span> <span class="k">in</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">validators</span>


    <span class="vi">@options.ajaxMethod = </span><span class="nx">@form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">ajaxMethod</span> <span class="o">==</span> <span class="kc">null</span>

    <span class="k">switch</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">ajaxMethod</span>
      <span class="k">when</span> <span class="s">&quot;post&quot;</span><span class="p">,</span> <span class="s">&quot;put&quot;</span><span class="p">,</span> <span class="s">&quot;delete&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Everything fine</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>I'm using get as the default since it's the default for forms.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@options.ajaxMethod = </span><span class="s">&quot;get&quot;</span>

    <span class="nx">@observe</span> <span class="s">&quot;submit&quot;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">onSubmit</span>
    <span class="nx">@observe</span> <span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">onSuccess</span>
    <span class="nx">@observe</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">onError</span>
    <span class="nx">@observe</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">onComplete</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">inputSelector</span><span class="p">,</span> <span class="nx">@form</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">input = </span><span class="nx">$</span> <span class="nx">input</span>
      <span class="nx">unless</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;initialized&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;hidden&quot;</span>
          <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;forceSubmission&quot;</span><span class="p">,</span> <span class="kc">true</span>
        <span class="k">else</span>
          <span class="nv">elements = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">decorate</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">input</span>
          <span class="k">if</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span> <span class="o">isnt</span> <span class="nx">input</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
            <span class="nx">elements</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;class&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;class&quot;</span><span class="p">)</span>
            <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
          <span class="nx">unless</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">label</span>
            <span class="nv">label = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">getLabel</span><span class="p">(</span><span class="nx">elements</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">automatchLabel</span><span class="p">)</span>
            <span class="nv">elements.label = </span><span class="nx">label</span>  <span class="k">if</span> <span class="nx">label</span>
          <span class="nx">unless</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">errors</span>
            <span class="nv">errorsElement = </span><span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">getErrorsElement</span> <span class="nx">elements</span><span class="p">,</span> <span class="kc">true</span>
            <span class="nv">elements.errors = </span><span class="nx">errorsElement</span>
          <span class="nx">@allElements</span><span class="p">.</span><span class="nx">push</span> <span class="nx">elements</span>
          <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;validators&quot;</span><span class="p">,</span> <span class="p">[]</span>
          <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">@validators</span>
            <span class="k">if</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">accepts</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">@</span>
              <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Validator \&quot;&quot;</span> <span class="o">+</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;\&quot; found for input field \&quot;&quot;</span> <span class="o">+</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;\&quot;.&quot;</span>
              <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;validators&quot;</span><span class="p">).</span><span class="nx">push</span> <span class="nx">validator</span>

          <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">storeInitialValue</span> <span class="nx">elements</span>
          <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;empty&quot;</span> <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

          <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">removeName</span> <span class="nx">elements</span> <span class="nx">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">submitUnchanged</span>

          <span class="nv">onchangeFunction = </span><span class="o">=&gt;</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">changed</span> <span class="nx">elements</span><span class="p">,</span> <span class="nx">@</span>
          <span class="nv">validateElementsFunction = </span><span class="o">=&gt;</span> <span class="nx">@validateElements</span> <span class="nx">elements</span><span class="p">,</span> <span class="kc">true</span>

          <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>
            <span class="p">(</span><span class="nf">(element) -&gt;</span>
              <span class="nx">element</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;focus&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;focus&quot;</span>
              <span class="nx">element</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;blur&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;focus&quot;</span>
              <span class="nx">element</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;change&quot;</span><span class="p">,</span> <span class="nx">onchangeFunction</span>
              <span class="nx">element</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;blur&quot;</span><span class="p">,</span> <span class="nx">onchangeFunction</span>
              <span class="nx">element</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;keyup&quot;</span><span class="p">,</span> <span class="nx">validateElementsFunction</span>
            <span class="p">)(</span><span class="nx">element</span><span class="p">)</span>

    <span class="nv">submitButtons = </span><span class="nx">$</span> <span class="s">&quot;input[type=submit], button[type=&#39;&#39;], button[type=&#39;submit&#39;], button:not([type])&quot;</span><span class="p">,</span> <span class="nx">@form</span>
    <span class="nv">hiddenSubmitButtonElement = </span><span class="nx">$</span><span class="p">.</span><span class="nx">create</span> <span class="s">&#39;&lt;input type=&quot;hidden&quot; name=&quot;&quot; value=&quot;&quot; /&gt;&#39;</span>
    <span class="nx">@form</span><span class="p">.</span><span class="nx">append</span> <span class="nx">hiddenSubmitButtonElement</span>
    <span class="nx">submitButtons</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">element = </span><span class="nx">$</span> <span class="nx">element</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">click</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">tagName</span> <span class="o">==</span> <span class="s">&quot;BUTTON&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>That's a IE7 bugfix: The <code>value</code> attribute of buttons in IE7 is always the content if a content is present.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">tmpElementText = </span><span class="nx">element</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">text</span> <span class="s">&quot;&quot;</span>
          <span class="nv">elementValue = </span><span class="nx">element</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot;&quot;</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">text</span> <span class="nx">tmpElementText</span>
        <span class="k">else</span>
          <span class="nv">elementValue = </span><span class="nx">element</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">?</span> <span class="s">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The submit buttons click events are always triggered if a user presses ENTER inside an input field.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">hiddenSubmitButtonElement</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nx">element</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">val</span> <span class="nx">elementValue</span>
        <span class="nx">@submitForm</span><span class="p">()</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">()</span>

  <span class="nv">callObservers: </span><span class="nf">(eventName, args...) -&gt;</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">args</span> <span class="k">for</span> <span class="nx">observer</span> <span class="k">in</span> <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span>

  <span class="nv">observe: </span><span class="nf">(eventName, func) -&gt;</span>
    <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="k">if</span> <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">is</span> <span class="o">`</span><span class="kc">undefined</span><span class="o">`</span>
    <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">push</span> <span class="nx">func</span>
    <span class="nx">@</span>

  <span class="nv">stopObserving: </span><span class="nf">(eventName, func) -&gt;</span>
    <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">observer</span> <span class="k">for</span> <span class="nx">observer</span> <span class="k">in</span> <span class="nx">@observers</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="k">when</span> <span class="nx">observer</span> <span class="o">isnt</span> <span class="nx">func</span><span class="p">)</span>
    <span class="nx">@</span>

  <span class="nv">enableForm: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">inputSelector</span><span class="p">,</span> <span class="nx">@form</span><span class="p">).</span><span class="nx">removeAttr</span> <span class="s">&quot;disabled&quot;</span>

  <span class="nv">disableForm: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">inputSelector</span><span class="p">,</span> <span class="nx">@form</span><span class="p">).</span><span class="nx">attr</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span>

  <span class="nv">submitForm: </span><span class="nf">(e) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">validate</span> <span class="o">or</span> <span class="nx">@validateForm</span><span class="p">()</span>
      <span class="nx">@callObservers</span> <span class="s">&quot;submit&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Do submit</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@form</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;submitting&quot;</span>
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">ajax</span>
        <span class="nx">@disableForm</span><span class="p">()</span>
        <span class="nx">@submitAjax</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">@form</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&quot;action&quot;</span><span class="p">,</span> <span class="nx">@form</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;originalAction&quot;</span><span class="p">)</span>
        <span class="nx">setTimeout</span> <span class="o">=&gt;</span>
          <span class="nx">@form</span><span class="p">.</span><span class="nx">submit</span><span class="p">()</span>
          <span class="nx">@disableForm</span><span class="p">()</span>
        <span class="p">,</span> <span class="mi">1</span>
        <span class="kc">false</span>

  <span class="nv">validateForm: </span><span class="o">-&gt;</span>
    <span class="nv">validated = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Not using _.detect() here, because I want every element to be inspected, even
if the first one fails.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">elements</span> <span class="k">in</span> <span class="nx">@allElements</span>
      <span class="nv">validated = </span><span class="kc">false</span> <span class="nx">unless</span> <span class="nx">@validateElements</span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span>

    <span class="nx">validated</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p><code>inlineValidating</code> specifies whether the user is still in the element, typing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">validateElements: </span><span class="nf">(elements, inlineValidating) -&gt;</span>
    <span class="nv">input = </span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span>
    <span class="nv">validated = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;validators&quot;</span><span class="p">).</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Only revalidated if the value has changed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">inlineValidating</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;lastValidatedValue&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;lastValidatedValue&quot;</span><span class="p">)</span> <span class="o">isnt</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;lastValidatedValue&quot;</span><span class="p">,</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
        <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Validating input &quot;</span> <span class="o">+</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;validationErrors&quot;</span><span class="p">,</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;validators&quot;</span>

          <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">is</span> <span class="s">&quot;&quot;</span> <span class="o">and</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">name</span> <span class="o">isnt</span> <span class="s">&quot;Required&quot;</span>
            <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Validating &quot;</span> <span class="o">+</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s">&quot;. Field was empty so continuing.&quot;</span>
            <span class="k">continue</span>

          <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Validating &quot;</span> <span class="o">+</span> <span class="nx">validator</span><span class="p">.</span><span class="nx">name</span>
          <span class="nv">validationOutput = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">validator</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()),</span> <span class="nx">input</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">validationOutput</span> <span class="o">isnt</span> <span class="kc">true</span>
            <span class="nv">validated = </span><span class="kc">false</span>
            <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;validationErrors&quot;</span><span class="p">).</span><span class="nx">push</span> <span class="nx">validationOutput</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="nx">validated</span>
          <span class="nx">elements</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
          <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;validated&quot;</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;error&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>When we remove an error during inline editing, the error has to
be shown again when the user leaves the input field, even if
the actual value has not changed.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">elements</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span> <span class="s">&quot;forceValidationOnChange&quot;</span><span class="p">,</span> <span class="kc">true</span>  <span class="k">if</span> <span class="nx">inlineValidating</span>

        <span class="k">else</span>

          <span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;validated&quot;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

          <span class="nx">unless</span> <span class="nx">inlineValidating</span>
            <span class="nx">elements</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;validationErrors&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;&quot;</span><span class="p">)).</span><span class="nx">show</span><span class="p">()</span>
            <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;error&quot;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

      <span class="k">if</span> <span class="o">not</span> <span class="nx">inlineValidating</span> <span class="o">and</span> <span class="nx">validated</span>
        <span class="nv">sanitizedValue = </span><span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;lastValidatedValue&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">validator</span> <span class="k">in</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;validators&quot;</span><span class="p">)</span>
          <span class="nv">sanitizedValue = </span><span class="nx">validator</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">sanitizedValue</span><span class="p">)</span>

        <span class="nx">input</span><span class="p">.</span><span class="nx">val</span> <span class="nx">sanitizedValue</span>
    <span class="k">else</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;validated&quot;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>

    <span class="nx">validated</span>

  <span class="nv">submitAjax: </span><span class="o">-&gt;</span>
    <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Submitting form via AJAX.&quot;</span>
    <span class="nv">fields = </span><span class="p">{</span> <span class="p">}</span>
    <span class="nv">fieldCount = </span><span class="mi">0</span>
    <span class="nv">i = </span><span class="mi">0</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">inputSelector</span><span class="p">,</span> <span class="nx">@form</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">input = </span><span class="nx">$</span> <span class="nx">input</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Buttons are only submitted when pressed. If a submit button triggers the submission
of the form then it creates a hidden input field to transmit it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&quot;BUTTON&quot;</span> <span class="o">or</span> <span class="p">(</span><span class="nx">input</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeName</span> <span class="o">==</span> <span class="s">&quot;INPUT&quot;</span> <span class="o">and</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;submit&quot;</span> <span class="o">or</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;button&quot;</span><span class="p">))</span>
        <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>In previous versions I checked if the input field was hidden, and forced the submission
then. But if a decorator transforms any input field in a hidden field, and puts
a JS selector on top of it, the actual input field will always be hidden, thus submitted.
So now the check if the field is hidden and should be submitted takes place
in the constructor, and sets <code>forceSubmission</code> on the input field.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;forceSubmission&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;checkbox&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">input</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&#39;changed&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">submitUnchanged</span>
        <span class="k">if</span> <span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;checkbox&quot;</span> <span class="o">||</span> <span class="nx">input</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">checked</span>
          <span class="nx">fieldCount</span><span class="o">++</span>
          <span class="nv">attributeName = </span><span class="nx">input</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;unnamedInput_</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">fields</span><span class="p">[</span><span class="nx">attributeName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">fieldCount</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">submitFormIfAllUnchanged</span>
      <span class="nx">setTimeout</span> <span class="o">=&gt;</span>
        <span class="nx">@enableForm</span><span class="p">()</span>
        <span class="nx">@ajaxSuccess</span><span class="p">()</span>
      <span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
        <span class="nv">url: </span><span class="nx">@form</span><span class="p">.</span><span class="nx">fwData</span><span class="p">(</span><span class="s">&quot;originalAction&quot;</span><span class="p">)</span>
        <span class="nv">method: </span><span class="nx">@options</span><span class="p">.</span><span class="nx">ajaxMethod</span>
        <span class="nv">data: </span><span class="nx">fields</span>
        <span class="nv">type: </span><span class="s">&quot;text&quot;</span>
        <span class="nv">error: </span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@callObservers</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span>
        <span class="nv">success: </span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@enableForm</span><span class="p">()</span>
          <span class="nx">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">responseCheck</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span>
            <span class="nx">@callObservers</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span>
          <span class="k">else</span>
            <span class="nx">@callObservers</span> <span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span>
            <span class="nx">@ajaxSuccess</span><span class="p">()</span>
        <span class="nv">complete: </span><span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@form</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;submitting&quot;</span>
          <span class="nx">@callObservers</span> <span class="s">&quot;complete&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">response</span>

  <span class="nv">ajaxSuccess: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">elements</span> <span class="k">in</span> <span class="nx">@allElements</span>
      <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">unsetChanged</span> <span class="nx">elements</span><span class="p">,</span> <span class="nx">@</span>
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">resetFormAfterSubmit</span>
        <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">restoreInitialValue</span> <span class="nx">elements</span>
      <span class="k">else</span>
        <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">storeInitialValue</span> <span class="nx">elements</span>
      <span class="nv">isEmpty = </span><span class="p">(</span><span class="nx">elements</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">is</span> <span class="kc">null</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">val</span><span class="p">())</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">element</span> <span class="k">of</span> <span class="nx">elements</span>
        <span class="k">if</span> <span class="nx">isEmpty</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&quot;empty&quot;</span>
        <span class="k">else</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&quot;empty&quot;</span>



<span class="k">if</span> <span class="nb">window</span><span class="o">?</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">Formwatcher = </span><span class="nx">Formwatcher</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">Watcher = </span><span class="nx">Watcher</span>

<span class="nx">$</span><span class="p">.</span><span class="nx">domReady</span> <span class="o">-&gt;</span> <span class="nx">Formwatcher</span><span class="p">.</span><span class="nx">scanDocument</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 